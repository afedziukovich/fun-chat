(()=>{"use strict";class e{constructor(){this.routes=new Map,this.currentRoute="",window.addEventListener("popstate",()=>{this.handleRouteChange()})}addRoute(e,t){console.log(`Router: –¥–æ–±–∞–≤–ª–µ–Ω –º–∞—Ä—à—Ä—É—Ç ${e}`),this.routes.set(e,t)}navigate(e){if(console.log(`Router: –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ ${e}, —Ç–µ–∫—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç ${this.currentRoute}`),e!==this.currentRoute)window.history.pushState({},"",e),this.currentRoute=e,this.handleRouteChange();else{console.log("Router: —É–∂–µ –Ω–∞ —ç—Ç–æ–º –º–∞—Ä—à—Ä—É—Ç–µ, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞");const t=this.routes.get(e);t&&t()}}getCurrentPath(){return window.location.pathname}start(){console.log("Router: –∑–∞–ø—É—â–µ–Ω"),this.handleRouteChange()}handleRouteChange(){const e=this.getCurrentPath();console.log(`Router: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ ${e}`),this.currentRoute=e;const t=this.routes.get(e);if(t)console.log(`Router: –Ω–∞–π–¥–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è ${e}`),t();else{console.log(`Router: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è ${e} –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –º–∞—Ä—à—Ä—É—Ç`);const t=this.routes.get("/");t?(console.log("Router: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ—Ä–Ω–µ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫"),t()):console.error("Router: –∫–æ—Ä–Ω–µ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω")}}}class t{constructor(){this.state={currentUser:null,isAuthenticated:!1,users:[],messages:{},userStatuses:{},unreadCounts:{}},this.listeners=new Set}getState(){return{...this.state}}setCurrentUser(e){this.state.currentUser=e,this.notifyListeners()}setAuthenticated(e){this.state.isAuthenticated=e,this.notifyListeners()}setUsers(e){this.state.users=e,this.notifyListeners()}setMessages(e){if(0===e.length)return;const t=e[0],s=t.from===this.state.currentUser?t.to:t.from;this.state.messages[s]=e,this.notifyListeners()}addMessage(e){const t=e.from===this.state.currentUser?e.to:e.from;this.state.messages[t]||(this.state.messages[t]=[]),this.state.messages[t].push(e),this.notifyListeners()}setUnreadCount(e,t){this.state.unreadCounts[e]=t,this.notifyListeners()}updateUserStatus(e,t){this.state.userStatuses[e]={isOnline:t},this.notifyListeners()}updateMessageStatus(e,t,s){for(const n in this.state.messages){const a=this.state.messages[n].find(t=>t.id===e);if(a){a.status.isDelivered=t,a.status.isReaded=s,this.notifyListeners();break}}}updateMessageText(e,t){for(const s in this.state.messages){const n=this.state.messages[s].find(t=>t.id===e);if(n){n.text=t,n.status.isEdited=!0,this.notifyListeners();break}}}deleteMessage(e){for(const t in this.state.messages){const s=this.state.messages[t].findIndex(t=>t.id===e);if(-1!==s){this.state.messages[t][s].status.isDeleted=!0,this.notifyListeners();break}}}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}notifyListeners(){const e=this.getState();this.listeners.forEach(t=>{try{t(e)}catch(e){console.error("StateManager listener error:",e)}})}}class s{constructor(){this.socket=null,this.messageHandlers=new Map,this.eventHandlers=new Map,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=3e3,console.log("üîå [WebSocketClient] –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤—ã–∑–≤–∞–Ω")}connect(e){console.log("üîå [WebSocketClient] connect() –≤—ã–∑–≤–∞–Ω —Å URL:",e),console.log("üîå [WebSocketClient] –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:",(new Date).toLocaleTimeString()),this.socket=new WebSocket(e),this.socket.onopen=()=>{console.log("‚úÖ [WebSocketClient] –°–û–ï–î–ò–ù–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!"),console.log("‚úÖ [WebSocketClient] WebSocket.OPEN =",WebSocket.OPEN),console.log("‚úÖ [WebSocketClient] readyState =",this.socket?.readyState),this.reconnectAttempts=0,this.emitEvent("connected",null)},this.socket.onmessage=e=>{console.log("üì® [WebSocketClient] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞"),console.log("üì® [WebSocketClient] RAW –¥–∞–Ω–Ω—ã–µ:",e.data);try{const t=JSON.parse(e.data);console.log("üì® [WebSocketClient] Parsed –¥–∞–Ω–Ω—ã–µ:",t),console.log("üì® [WebSocketClient] –¢–∏–ø —Å–æ–±—ã—Ç–∏—è:",t.type),t.payload&&console.log("üì® [WebSocketClient] Payload:",t.payload),this.handleMessage(t)}catch(e){console.error("‚ùå [WebSocketClient] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:",e)}},this.socket.onclose=()=>{console.log("‚ö†Ô∏è [WebSocketClient] –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ"),console.log("‚ö†Ô∏è [WebSocketClient] –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:",this.reconnectAttempts+1),this.emitEvent("disconnected",null),this.attemptReconnect(e)},this.socket.onerror=e=>{console.error("‚ùå [WebSocketClient] WebSocket –æ—à–∏–±–∫–∞:",e),this.emitEvent("error",e)}}attemptReconnect(e){this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,console.log("üîÑ [WebSocketClient] –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑",this.reconnectDelay,"–º—Å"),setTimeout(()=>{console.log("üîÑ [WebSocketClient] –ü—ã—Ç–∞—é—Å—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è..."),this.connect(e)},this.reconnectDelay)):console.error("‚ùå [WebSocketClient] –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ")}handleMessage(e){if(console.log("üì® [WebSocketClient] handleMessage() –≤—ã–∑–≤–∞–Ω"),console.log("üì® [WebSocketClient] Response ID:",e.id),console.log("üì® [WebSocketClient] Response Type:",e.type),e.id&&this.messageHandlers.has(e.id)){const t=this.messageHandlers.get(e.id);t&&(console.log("üì® [WebSocketClient] –ù–∞–π–¥–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è ID:",e.id),t(e),this.messageHandlers.delete(e.id))}this.emitEvent(e.type,e.payload)}sendRequest(e){if(console.log("üì§ [WebSocketClient] sendRequest() –≤—ã–∑–≤–∞–Ω"),console.log("üì§ [WebSocketClient] Request:",e),console.log("üì§ [WebSocketClient] readyState:",this.socket?.readyState),this.socket&&this.socket.readyState===WebSocket.OPEN){const t=JSON.stringify(e);console.log("üì§ [WebSocketClient] –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ:",t),this.socket.send(t)}else console.error("‚ùå [WebSocketClient] WebSocket –ù–ï –ü–û–î–ö–õ–Æ–ß–ï–ù! readyState:",this.socket?.readyState)}onMessage(e,t){console.log("üéØ [WebSocketClient] onMessage() –¥–ª—è ID:",e),this.messageHandlers.set(e,t)}onEvent(e,t){console.log("üéØ [WebSocketClient] onEvent() –¥–ª—è —Å–æ–±—ã—Ç–∏—è:",e),this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e)?.push(t)}removeEvent(e,t){console.log("üéØ [WebSocketClient] removeEvent() –¥–ª—è —Å–æ–±—ã—Ç–∏—è:",e);const s=this.eventHandlers.get(e);if(s){const e=s.indexOf(t);e>-1&&s.splice(e,1)}}emitEvent(e,t){console.log("üéØ [WebSocketClient] emitEvent() —Å–æ–±—ã—Ç–∏–µ:",e),console.log("üéØ [WebSocketClient] –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:",t);const s=this.eventHandlers.get(e);s?(console.log("üéØ [WebSocketClient] –ù–∞–π–¥–µ–Ω–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:",s.length),s.forEach(e=>{try{e(t)}catch(e){console.error("‚ùå [WebSocketClient] –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Å–æ–±—ã—Ç–∏—è:",e)}})):console.log("üéØ [WebSocketClient] –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —Å–æ–±—ã—Ç–∏—è:",e)}disconnect(){console.log("üîå [WebSocketClient] disconnect() –≤—ã–∑–≤–∞–Ω"),this.socket&&(this.socket.close(),this.socket=null)}}class n{static validateLogin(e){return e.length<4||e.length>12?"–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤":/^[a-zA-Z0-9]+$/.test(e)?"":"–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã"}static validatePassword(e){return e.length<4||e.length>12?"–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤":/^[a-zA-Z0-9]+$/.test(e)?"":"–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã"}static validateLoginForm(e,t){const s=this.validateLogin(e);if(s)return s;return this.validatePassword(t)||""}}class a{constructor(e,t){this.loginCallback=e,this.showAboutCallback=t,this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className="auth-page";const e=document.createElement("div");e.className="auth-container";const t=document.createElement("h1");t.textContent="–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è",t.className="auth-title";const s=document.createElement("label");s.textContent="–ò–º—è",s.className="auth-label";const n=document.createElement("input");n.type="text",n.placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è",n.className="auth-input",n.id="login-input";const a=document.createElement("label");a.textContent="–ü–∞—Ä–æ–ª—å",a.className="auth-label";const i=document.createElement("input");i.type="password",i.placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å",i.className="auth-input",i.id="password-input";const o=document.createElement("button");o.textContent="–í–æ–π—Ç–∏",o.className="auth-button";const r=document.createElement("button");r.textContent="–ò–Ω—Ñ–æ",r.className="auth-info-button";const l=document.createElement("div");l.className="auth-error",l.id="auth-error";const d=document.createElement("button");d.textContent="RU",d.className="auth-language-button",n.addEventListener("input",()=>this.validateForm()),i.addEventListener("input",()=>this.validateForm()),o.addEventListener("click",()=>this.handleLogin()),r.addEventListener("click",()=>this.showAboutCallback()),n.addEventListener("keypress",e=>{"Enter"===e.key&&this.handleLogin()}),i.addEventListener("keypress",e=>{"Enter"===e.key&&this.handleLogin()}),e.appendChild(t),e.appendChild(s),e.appendChild(n),e.appendChild(a),e.appendChild(i),e.appendChild(o),e.appendChild(r),e.appendChild(l),e.appendChild(d),this.element.appendChild(e);const c=document.createElement("div");c.className="auth-footer";const h=(new Date).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),u=(new Date).toLocaleDateString("ru-RU");return c.textContent=h+" "+u,this.element.appendChild(c),this.element}validateForm(){const e=document.getElementById("login-input"),t=document.getElementById("password-input"),s=document.querySelector(".auth-button");if(e&&t&&s){const a=e.value.trim(),i=t.value.trim(),o=n.validateLoginForm(a,i);s.disabled=!!o}}handleLogin(){const e=document.getElementById("login-input"),t=document.getElementById("password-input");if(e&&t){const s=e.value.trim(),a=t.value.trim(),i=n.validateLoginForm(s,a);if(i)return void this.showError(i);this.loginCallback(s,a)}}showError(e){const t=document.getElementById("auth-error");t&&(t.textContent=e,t.style.display="block")}clearError(){const e=document.getElementById("auth-error");e&&(e.textContent="",e.style.display="none")}}class i{constructor(e,t,s){this.userName=e,this.logoutCallback=t,this.showAboutCallback=s,this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className="header";const e=document.createElement("div");e.className="header-user-info",e.textContent=`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${this.userName}`;const t=document.createElement("div");t.className="header-app-name",t.textContent="–í–µ—Å–µ–ª—ã–π —á–∞—Ç–∏–∫";const s=document.createElement("div");s.className="header-buttons";const n=document.createElement("button");n.textContent="–ò–Ω—Ñ–æ",n.className="header-button",n.addEventListener("click",()=>this.showAboutCallback());const a=document.createElement("button");a.textContent="–í—ã—Ö–æ–¥",a.className="header-button",a.addEventListener("click",()=>this.logoutCallback());const i=document.createElement("button");return i.textContent="RU",i.className="header-language-button",s.appendChild(n),s.appendChild(a),s.appendChild(i),this.element.appendChild(e),this.element.appendChild(t),this.element.appendChild(s),this.element}updateUserName(e){this.userName=e;const t=this.element.querySelector(".header-user-info");t&&(t.textContent=`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${e}`)}}class o{constructor(){this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className="footer";const e=(new Date).getFullYear(),t=document.createElement("div");t.className="footer-content";const s=document.createElement("span");s.textContent="RSSchool";const n=document.createElement("a");n.href="https://github.com/afedziukovich",n.textContent="afedziukovich",n.target="_blank",n.rel="noopener noreferrer";const a=document.createElement("span");return a.textContent=e.toString(),t.appendChild(s),t.appendChild(n),t.appendChild(a),this.element.appendChild(t),this.element}}class r{constructor(){this.users=[],this.currentUser="",this.unreadCounts=new Map,this.userClickCallback=()=>{},this.element=document.createElement("div")}setUserClickCallback(e){this.userClickCallback=e}render(){this.element.innerHTML="",this.element.className="user-list";const e=document.createElement("div");e.className="user-search-container";const t=document.createElement("input");t.type="text",t.placeholder="–ü–æ–∏—Å–∫...",t.className="user-search-input",t.addEventListener("input",e=>{this.filterUsers(e.target.value)}),e.appendChild(t),this.element.appendChild(e);const s=document.createElement("div");return s.className="users-container",s.id="users-container",this.element.appendChild(s),this.renderUsers(),this.element}setCurrentUser(e){this.currentUser=e,this.renderUsers()}setUsers(e){this.users=e.filter(e=>e.login!==this.currentUser),this.renderUsers()}setUnreadCount(e,t){this.unreadCounts.set(e,t),this.updateUserItem(e)}filterUsers(e){const t=this.users.filter(t=>t.login.toLowerCase().includes(e.toLowerCase()));this.renderFilteredUsers(t)}renderUsers(){const e=this.users.filter(e=>e.login!==this.currentUser);this.renderFilteredUsers(e)}renderFilteredUsers(e){const t=document.getElementById("users-container");if(t){if(t.innerHTML="",0===e.length){const e=document.createElement("div");return e.className="user-empty-message",e.textContent="–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",void t.appendChild(e)}e.forEach(e=>{const s=this.createUserElement(e);t.appendChild(s)})}}createUserElement(e){const t=document.createElement("div");t.className="user-item",t.dataset.login=e.login;const s=document.createElement("span");s.className="user-name",s.textContent=e.login;const n=document.createElement("span");n.className="user-status "+(e.isLogined?"online":"offline"),n.title=e.isLogined?"–í —Å–µ—Ç–∏":"–ù–µ –≤ —Å–µ—Ç–∏";const a=document.createElement("span");a.className="user-unread-badge";const i=this.unreadCounts.get(e.login)||0;return i>0?(a.textContent=i.toString(),a.style.display="inline-block"):a.style.display="none",t.appendChild(s),t.appendChild(n),t.appendChild(a),t.addEventListener("click",()=>{this.userClickCallback(e.login)}),t}updateUserItem(e){const t=this.element.querySelector('.user-item[data-login="'+e+'"]');if(!t)return;const s=t.querySelector(".user-unread-badge"),n=this.unreadCounts.get(e)||0;s&&(n>0?(s.textContent=n.toString(),s.style.display="inline-block"):s.style.display="none")}updateUserStatus(e,t){const s=this.users.find(t=>t.login===e);if(s){s.isLogined=t;const n=this.element.querySelector('.user-item[data-login="'+e+'"]');if(n){const e=n.querySelector(".user-status");e&&(e.className="user-status "+(t?"online":"offline"),e.title=t?"–í —Å–µ—Ç–∏":"–ù–µ –≤ —Å–µ—Ç–∏")}}}}class l{constructor(e,t,s,n){this.message=e,this.isCurrentUser=t,this.onDelete=s,this.onEdit=n,this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className="message-item "+(this.isCurrentUser?"own":"other"),this.element.dataset.messageId=this.message.id;const e=document.createElement("div");e.className="message-header";const t=document.createElement("span");t.className="message-sender",t.textContent=this.isCurrentUser?"–í—ã":this.message.from;const s=document.createElement("span");s.className="message-time";const n=new Date(this.message.datetime);s.textContent=n.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),e.appendChild(t),e.appendChild(s);const a=document.createElement("div");if(a.className="message-content",this.message.status.isDeleted){const e=document.createElement("div");e.className="message-text deleted",e.textContent="–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ",a.appendChild(e)}else{const e=document.createElement("div");if(e.className="message-text",e.textContent=this.message.text,this.message.status.isEdited){const t=document.createElement("span");t.className="message-edited",t.textContent=" (–∏–∑–º–µ–Ω–µ–Ω–æ)",e.appendChild(t)}a.appendChild(e)}const i=document.createElement("div");if(i.className="message-footer",this.isCurrentUser){const e=document.createElement("div");e.className="message-status-container";const t=document.createElement("span");if(t.className="message-status-icon",this.message.status.isReaded?(t.textContent="‚úì‚úì",t.title="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"):this.message.status.isDelivered?(t.textContent="‚úì",t.title="–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ"):(t.textContent="‚è≥",t.title="–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è"),e.appendChild(t),i.appendChild(e),!this.message.status.isDeleted){const e=document.createElement("div");e.className="message-actions";const t=document.createElement("button");t.textContent="‚úé",t.className="message-action-button",t.title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å",t.addEventListener("click",()=>this.handleEdit());const s=document.createElement("button");s.textContent="üóë",s.className="message-action-button",s.title="–£–¥–∞–ª–∏—Ç—å",s.addEventListener("click",()=>{this.onDelete&&this.onDelete(this.message.id)}),e.appendChild(t),e.appendChild(s),i.appendChild(e)}}return this.element.appendChild(e),this.element.appendChild(a),this.element.appendChild(i),this.element}handleEdit(){const e=prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:",this.message.text);null!==e&&""!==e.trim()&&this.onEdit&&this.onEdit(this.message.id,e.trim())}updateStatus(e,t){this.message.status.isDelivered=e,this.message.status.isReaded=t;const s=this.element.querySelector(".message-status-icon");s&&(t?(s.textContent="‚úì‚úì",s.title="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"):e&&(s.textContent="‚úì",s.title="–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ"))}updateText(e,t){this.message.text=e,this.message.status.isEdited=t;const s=this.element.querySelector(".message-text");if(s&&(s.textContent=e,t)){const e=document.createElement("span");e.className="message-edited",e.textContent=" (–∏–∑–º–µ–Ω–µ–Ω–æ)",s.appendChild(e)}}markAsDeleted(){this.message.status.isDeleted=!0,this.render()}}class d{constructor(e,t,s,n){this.onSendMessage=e,this.onDeleteMessage=t,this.onEditMessage=s,this.onMarkAsRead=n,this.messages=[],this.currentUser="",this.selectedUser="",this.messageItems=new Map,this.hasUnreadDivider=!1,this.unreadDividerElement=null,this.lastReadIndex=-1,this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className="chat-dialog";const e=document.createElement("div");e.className="dialog-header";const t=document.createElement("div");t.className="dialog-user-info",t.id="dialog-user-info";const s=document.createElement("span");s.className="dialog-user-status",s.id="dialog-user-status",t.appendChild(s),e.appendChild(t),this.element.appendChild(e);const n=document.createElement("div");n.className="messages-container",n.id="messages-container",n.addEventListener("scroll",()=>this.handleScroll()),n.addEventListener("click",()=>this.handleClick()),this.element.appendChild(n);const a=document.createElement("div");a.className="message-input-container";const i=document.createElement("input");i.type="text",i.placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",i.className="message-input",i.id="message-input",i.disabled=!this.selectedUser;const o=document.createElement("button");return o.textContent="–û—Ç–ø—Ä–∞–≤–∏—Ç—å",o.className="send-button",o.id="send-button",o.disabled=!this.selectedUser,i.addEventListener("keypress",e=>{"Enter"!==e.key||o.disabled||this.sendMessage()}),o.addEventListener("click",()=>{this.sendMessage()}),a.appendChild(i),a.appendChild(o),this.element.appendChild(a),this.updateDialogInfo(),this.renderMessages(),this.element}setCurrentUser(e){this.currentUser=e}setSelectedUser(e,t){this.selectedUser=e,this.messages=[],this.messageItems.clear(),this.hasUnreadDivider=!1,this.lastReadIndex=-1;const s=document.getElementById("message-input"),n=document.getElementById("send-button");s&&n&&(s.disabled=!e,n.disabled=!e,s.value=""),this.updateDialogInfo(e,t),this.renderMessages()}setMessages(e){this.messages=e.sort((e,t)=>e.datetime-t.datetime),this.messageItems.clear();const t=this.findLastReadIndex();-1!==t&&t<this.messages.length-1?(this.hasUnreadDivider=!0,this.lastReadIndex=t):(this.hasUnreadDivider=!1,this.lastReadIndex=-1),this.renderMessages()}addMessage(e){this.messages.push(e),this.messageItems.delete(e.id),e.to!==this.currentUser||e.status.isReaded||(this.hasUnreadDivider=!0),this.renderMessages(),this.scrollToBottom()}updateMessageStatus(e,t,s){const n=this.messageItems.get(e);if(n&&n.updateStatus(t,s),s&&this.hasUnreadDivider){const t=this.messages.findIndex(t=>t.id===e);t>this.lastReadIndex&&(this.lastReadIndex=t,this.checkUnreadDivider())}}updateMessageText(e,t,s){const n=this.messageItems.get(e);n&&n.updateText(t,s)}deleteMessage(e){const t=this.messageItems.get(e);t&&t.markAsDeleted()}updateUserStatus(e){this.updateDialogInfo(this.selectedUser,e)}updateDialogInfo(e,t){const s=document.getElementById("dialog-user-info"),n=document.getElementById("dialog-user-status");s&&n&&(e?(n.textContent=e,n.className="dialog-user-status "+(t?"online":"offline"),n.title=t?"–í —Å–µ—Ç–∏":"–ù–µ –≤ —Å–µ—Ç–∏"):(n.textContent="–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è...",n.className="dialog-user-status"))}renderMessages(){const e=document.getElementById("messages-container");if(e){if(e.innerHTML="",0===this.messages.length){const t=document.createElement("div");return t.className="empty-dialog-message",this.selectedUser?t.textContent="–≠—Ç–æ –Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞":t.textContent="–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è...",void e.appendChild(t)}this.messages.forEach((t,s)=>{const n=t.from===this.currentUser;this.hasUnreadDivider&&s===this.lastReadIndex+1&&(this.unreadDividerElement=document.createElement("div"),this.unreadDividerElement.className="unread-divider",this.unreadDividerElement.textContent="–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è",e.appendChild(this.unreadDividerElement));const a=new l(t,n,n?this.onDeleteMessage:void 0,n?this.onEditMessage:void 0),i=a.render();this.messageItems.set(t.id,a),t.to!==this.currentUser||t.status.isReaded||this.onMarkAsRead(t.id),e.appendChild(i)}),this.scrollToBottom()}}sendMessage(){const e=document.getElementById("message-input");if(!e||!e.value.trim())return;const t=e.value.trim();this.onSendMessage(t),e.value=""}scrollToBottom(){const e=document.getElementById("messages-container");e&&(e.scrollTop=e.scrollHeight)}handleScroll(){if(this.hasUnreadDivider&&this.unreadDividerElement){const e=document.getElementById("messages-container");if(e){const t=this.unreadDividerElement.getBoundingClientRect(),s=e.getBoundingClientRect();t.top>s.top&&this.removeUnreadDivider()}}}handleClick(){this.hasUnreadDivider&&this.removeUnreadDivider()}removeUnreadDivider(){this.hasUnreadDivider=!1,this.unreadDividerElement&&(this.unreadDividerElement.remove(),this.unreadDividerElement=null)}findLastReadIndex(){for(let e=this.messages.length-1;e>=0;e--)if(this.messages[e].status.isReaded)return e;return-1}checkUnreadDivider(){!this.messages.some((e,t)=>t>this.lastReadIndex&&!e.status.isReaded)&&this.hasUnreadDivider&&this.removeUnreadDivider()}}class c{constructor(e,t,s,n,a,l,c,h,u){this.selectedUser="",this.unsubscribe=null,this.element=document.createElement("div"),this.element.className="main-page",this.stateManager=u,this.header=new i(e,t,s),this.footer=new o,this.userList=new r,this.chatDialog=new d(e=>{this.selectedUser&&n(this.selectedUser,e)},a,l,c),this.chatDialog.setCurrentUser(e),this.userList.setUserClickCallback(e=>{this.selectedUser=e,this.chatDialog.setSelectedUser(e,!0),h(e)}),this.subscribeToState()}subscribeToState(){this.unsubscribe&&this.unsubscribe(),this.unsubscribe=this.stateManager.subscribe(e=>{e.users&&this.setUsers(e.users),e.userStatuses&&Object.entries(e.userStatuses).forEach(([e,t])=>{this.updateUserStatus(e,t.isOnline)}),this.selectedUser&&e.messages&&e.messages[this.selectedUser]&&this.setMessages(e.messages[this.selectedUser]),e.unreadCounts&&Object.entries(e.unreadCounts).forEach(([e,t])=>{this.setUnreadCount(e,t)})})}render(){this.element.innerHTML="";const e=this.header.render();this.element.appendChild(e);const t=document.createElement("div");t.className="main-content";const s=document.createElement("div");s.className="sidebar";const n=this.userList.render();s.appendChild(n);const a=this.chatDialog.render();t.appendChild(s),t.appendChild(a),this.element.appendChild(t);const i=this.footer.render();return this.element.appendChild(i),this.element}destroy(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}updateUserName(e){this.header.updateUserName(e),this.chatDialog.setCurrentUser(e)}setUsers(e){this.userList.setUsers(e)}setUnreadCount(e,t){this.userList.setUnreadCount(e,t)}setMessages(e){this.chatDialog.setMessages(e)}addMessage(e){this.chatDialog.addMessage(e)}updateMessageStatus(e,t,s){this.chatDialog.updateMessageStatus(e,t,s)}updateMessageText(e,t,s){this.chatDialog.updateMessageText(e,t,s)}deleteMessage(e){this.chatDialog.deleteMessage(e)}updateUserStatus(e,t){this.userList.updateUserStatus(e,t),e===this.selectedUser&&this.chatDialog.updateUserStatus(t)}}class h{constructor(e){this.backCallback=e,this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className="about-page";const e=document.createElement("div");e.className="about-container";const t=document.createElement("h1");t.textContent="–í–µ—Å–µ–ª—ã–π —á–∞—Ç",t.className="about-title";const s=document.createElement("div");s.className="about-description",s.innerHTML="\n      –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–Ω–∏—è Fun Chat –≤ —Ä–∞–º–∫–∞—Ö –∫—É—Ä—Å–∞ RSSchool JS/FE 2025Q3<br>\n      –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–¥–∏–Ω —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏\n    ";const n=document.createElement("div");n.className="about-author",n.textContent="–ê–≤—Ç–æ—Ä MikAleinik, Afedziukovich";const a=document.createElement("button");return a.textContent="–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥",a.className="about-back-button",a.addEventListener("click",()=>this.backCallback()),e.appendChild(t),e.appendChild(s),e.appendChild(n),e.appendChild(a),this.element.appendChild(e),this.element}}(new class{constructor(){this.currentPage=null,this.mainPage=null,this.messageCounter=0,this.appContainer=document.getElementById("app"),this.router=new e,this.stateManager=new t,this.wsClient=new s,this.authPage=new a((e,t)=>this.handleLogin(e,t),()=>this.router.navigate("/about")),this.aboutPage=new h(()=>{this.stateManager.getState().isAuthenticated?this.router.navigate("/main"):this.router.navigate("/")}),this.setupRouter(),this.setupWebSocket()}init(){this.router.start()}setupRouter(){this.router.addRoute("/",()=>{this.stateManager.getState().isAuthenticated?this.router.navigate("/main"):this.showAuthPage()}),this.router.addRoute("/main",()=>{this.stateManager.getState().isAuthenticated?this.showMainPage():this.router.navigate("/")}),this.router.addRoute("/about",()=>{this.showAboutPage()})}setupWebSocket(){this.wsClient.connect("wss://fun-chat-server.onrender.com"),this.wsClient.onEvent("connected",()=>{console.log("WebSocket: Connected to server")}),this.wsClient.onEvent("disconnected",()=>{console.log("WebSocket: Disconnected from server")}),this.wsClient.onEvent("error",e=>{console.error("WebSocket error:",e)}),this.wsClient.onEvent("USER_LOGIN",e=>{console.log("WebSocket: USER_LOGIN received");const t=e;t.user.isLogined&&(console.log("Login successful, navigating to /main"),this.stateManager.setCurrentUser(t.user.login),this.stateManager.setAuthenticated(!0),this.requestActiveUsers(),this.router.navigate("/main"))}),this.wsClient.onEvent("ERROR",e=>{const t=e;this.currentPage===this.authPage.render()&&this.authPage.showError(t.error)}),this.wsClient.onEvent("USER_EXTERNAL_LOGIN",e=>{const t=e;this.updateUserStatus(t.user.login,!0)}),this.wsClient.onEvent("USER_EXTERNAL_LOGOUT",e=>{const t=e;this.updateUserStatus(t.user.login,!1)}),this.wsClient.onEvent("USER_ACTIVE",e=>{const t=e;this.stateManager.setUsers(t.users)}),this.wsClient.onEvent("MSG_SEND",e=>{const t=e;this.handleIncomingMessage(t.message)}),this.wsClient.onEvent("MSG_DELIVER",e=>{const t=e;this.stateManager.updateMessageStatus(t.message.id,!0,!1)}),this.wsClient.onEvent("MSG_READ",e=>{const t=e;this.stateManager.updateMessageStatus(t.message.id,!0,!0)}),this.wsClient.onEvent("MSG_EDIT",e=>{const t=e;this.stateManager.updateMessageText(t.message.id,t.message.text)}),this.wsClient.onEvent("MSG_DELETE",e=>{const t=e;this.stateManager.deleteMessage(t.message.id)})}showAuthPage(){console.log("Showing auth page"),this.currentPage=this.authPage.render(),this.appContainer.innerHTML="",this.appContainer.appendChild(this.currentPage)}showMainPage(){console.log("Showing main page");const e=this.stateManager.getState();this.mainPage?(console.log("Updating existing MainPage"),this.mainPage.updateUserName(e.currentUser)):(console.log("Creating new MainPage"),this.mainPage=new c(e.currentUser,()=>this.handleLogout(),()=>this.router.navigate("/about"),(e,t)=>this.sendMessage(e,t),e=>this.deleteMessage(e),(e,t)=>this.editMessage(e,t),e=>this.markAsRead(e),e=>this.requestMessages(e),this.stateManager)),this.currentPage=this.mainPage.render(),this.appContainer.innerHTML="",this.appContainer.appendChild(this.currentPage)}showAboutPage(){console.log("Showing about page"),this.currentPage=this.aboutPage.render(),this.appContainer.innerHTML="",this.appContainer.appendChild(this.currentPage)}handleLogin(e,t){const s=this.generateRequestId();this.wsClient.onMessage(s,e=>{"ERROR"===e.type&&this.authPage.showError(e.payload.error)}),this.wsClient.sendRequest({id:s,type:"USER_LOGIN",payload:{user:{login:e,password:t}}})}handleLogout(){const e=this.stateManager.getState(),t=this.generateRequestId();this.wsClient.sendRequest({id:t,type:"USER_LOGOUT",payload:{user:{login:e.currentUser,password:""}}}),this.stateManager.setAuthenticated(!1),this.stateManager.setCurrentUser(null),this.mainPage=null,this.router.navigate("/")}requestActiveUsers(){const e=this.generateRequestId();this.wsClient.sendRequest({id:e,type:"USER_ACTIVE",payload:null})}sendMessage(e,t){if(!t.trim())return;const s=this.generateRequestId();this.wsClient.sendRequest({id:s,type:"MSG_SEND",payload:{message:{to:e,text:t}}})}deleteMessage(e){const t=this.generateRequestId();this.wsClient.sendRequest({id:t,type:"MSG_DELETE",payload:{message:{id:e}}})}editMessage(e,t){if(!t.trim())return;const s=this.generateRequestId();this.wsClient.sendRequest({id:s,type:"MSG_EDIT",payload:{message:{id:e,text:t}}})}markAsRead(e){const t=this.generateRequestId();this.wsClient.sendRequest({id:t,type:"MSG_READ",payload:{message:{id:e}}})}requestMessages(e){const t=this.generateRequestId();this.wsClient.onMessage(t,e=>{if("MSG_FROM_USER"===e.type){const t=e.payload.messages;this.stateManager.setMessages(t)}}),this.wsClient.sendRequest({id:t,type:"MSG_FROM_USER",payload:{user:{login:e}}});const s=this.generateRequestId();this.wsClient.onMessage(s,t=>{if("MSG_COUNT_NOT_READED_FROM_USER"===t.type){const s=t.payload.count;this.stateManager.setUnreadCount(e,s)}}),this.wsClient.sendRequest({id:s,type:"MSG_COUNT_NOT_READED_FROM_USER",payload:{user:{login:e}}})}handleIncomingMessage(e){this.stateManager.addMessage(e)}updateUserStatus(e,t){const s=this.stateManager.getState().users.map(s=>s.login===e?{...s,isLogined:t}:s);this.stateManager.setUsers(s)}generateRequestId(){return this.messageCounter++,`req_${Date.now()}_${this.messageCounter}`}}).init()})();