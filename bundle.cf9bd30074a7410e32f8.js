(()=>{"use strict";class e{constructor(){this.routes=new Map,window.addEventListener("hashchange",()=>this.handleRoute())}addRoute(e,t){this.routes.set(e,t)}navigate(e){window.location.hash=e}start(){this.handleRoute()}handleRoute(){const e=window.location.hash.slice(1)||"/login",t=this.routes.get(e);t?t():console.error("Route not found:",e)}}class t{constructor(){this.state={currentUser:null,isAuthenticated:!1,users:[],messages:{},userStatuses:{},unreadCounts:{}},this.listeners=new Set}getState(){return{...this.state}}setCurrentUser(e){this.state.currentUser=e,this.notifyListeners()}setAuthenticated(e){this.state.isAuthenticated=e,this.notifyListeners()}setUsers(e){this.state.users=e,this.notifyListeners()}setMessages(e){if(0===e.length)return;const t=e[0],s=t.from===this.state.currentUser?t.to:t.from;this.state.messages[s]=e,this.notifyListeners()}addMessage(e){const t=e.from===this.state.currentUser?e.to:e.from;this.state.messages[t]||(this.state.messages[t]=[]),this.state.messages[t].push(e),this.notifyListeners()}setUnreadCount(e,t){this.state.unreadCounts[e]=t,this.notifyListeners()}updateUserStatus(e,t){this.state.userStatuses[e]={isOnline:t},this.notifyListeners()}updateMessageStatus(e,t,s){for(const n in this.state.messages){const a=this.state.messages[n].find(t=>t.id===e);if(a){a.status.isDelivered=t,a.status.isReaded=s,this.notifyListeners();break}}}updateMessageText(e,t){for(const s in this.state.messages){const n=this.state.messages[s].find(t=>t.id===e);if(n){n.text=t,n.status.isEdited=!0,this.notifyListeners();break}}}deleteMessage(e){for(const t in this.state.messages){const s=this.state.messages[t].findIndex(t=>t.id===e);if(-1!==s){this.state.messages[t][s].status.isDeleted=!0,this.notifyListeners();break}}}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}notifyListeners(){const e=this.getState();this.listeners.forEach(t=>{try{t(e)}catch(e){console.error("StateManager listener error:",e)}})}}var s;!function(e){e.CONNECTED="connected",e.DISCONNECTED="disconnected",e.ERROR="error",e.ERROR_RESPONSE="ERROR",e.USER_LOGIN="USER_LOGIN",e.USER_EXTERNAL_LOGIN="USER_EXTERNAL_LOGIN",e.USER_EXTERNAL_LOGOUT="USER_EXTERNAL_LOGOUT",e.USER_ACTIVE="USER_ACTIVE",e.USER_LOGOUT="USER_LOGOUT",e.MSG_SEND="MSG_SEND",e.MSG_FROM_USER="MSG_FROM_USER",e.MSG_DELIVER="MSG_DELIVER",e.MSG_READ="MSG_READ",e.MSG_EDIT="MSG_EDIT",e.MSG_DELETE="MSG_DELETE",e.MSG_COUNT_NOT_READED_FROM_USER="MSG_COUNT_NOT_READED_FROM_USER"}(s||(s={}));class n{constructor(){this.socket=null,this.messageHandlers=new Map,this.eventHandlers=new Map,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=3e3}connect(e){this.socket=new WebSocket(e),this.socket.onopen=()=>{this.reconnectAttempts=0,this.emitEvent(s.CONNECTED,null)},this.socket.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleMessage(t)}catch(e){console.error("WebSocket JSON parse error:",e)}},this.socket.onclose=()=>{this.emitEvent(s.DISCONNECTED,null),this.attemptReconnect(e)},this.socket.onerror=e=>{this.emitEvent(s.ERROR,e)}}attemptReconnect(e){this.reconnectAttempts<this.maxReconnectAttempts&&(this.reconnectAttempts++,setTimeout(()=>{this.connect(e)},this.reconnectDelay))}handleMessage(e){if(e.id&&this.messageHandlers.has(e.id)){const t=this.messageHandlers.get(e.id);t&&(t(e),this.messageHandlers.delete(e.id))}this.emitEvent(e.type,e.payload)}sendRequest(e){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(JSON.stringify(e)):console.error("WebSocket not connected")}onMessage(e,t){this.messageHandlers.set(e,t)}onEvent(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e)?.push(t)}emitEvent(e,t){const s=this.eventHandlers.get(e);s&&s.forEach(e=>{try{e(t)}catch(e){console.error("Event handler error:",e)}})}disconnect(){this.socket&&(this.socket.close(),this.socket=null)}}class a{static validateLogin(e){return e.length<4||e.length>12?"–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤":/^[a-zA-Z0-9]+$/.test(e)?"":"–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã"}static validatePassword(e){return e.length<4||e.length>12?"–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤":/^[a-zA-Z0-9]+$/.test(e)?"":"–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã"}static validateLoginForm(e,t){const s=this.validateLogin(e);if(s)return s;return this.validatePassword(t)||""}}class i{constructor(e,t){this.loginCallback=e,this.showAboutCallback=t,this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className="auth-page";const e=document.createElement("div");e.className="auth-container";const t=document.createElement("h1");t.textContent="–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è",t.className="auth-title";const s=document.createElement("label");s.textContent="–ò–º—è",s.className="auth-label";const n=document.createElement("input");n.type="text",n.placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è",n.className="auth-input",n.id="login-input";const a=document.createElement("label");a.textContent="–ü–∞—Ä–æ–ª—å",a.className="auth-label";const i=document.createElement("input");i.type="password",i.placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å",i.className="auth-input",i.id="password-input";const r=document.createElement("button");r.textContent="–í–æ–π—Ç–∏",r.className="auth-button";const d=document.createElement("button");d.textContent="–ò–Ω—Ñ–æ",d.className="auth-info-button";const o=document.createElement("div");o.className="auth-error",o.id="auth-error";const l=document.createElement("button");l.textContent="RU",l.className="auth-language-button",n.addEventListener("input",()=>this.validateForm()),i.addEventListener("input",()=>this.validateForm()),r.addEventListener("click",()=>this.handleLogin()),d.addEventListener("click",()=>this.showAboutCallback()),n.addEventListener("keypress",e=>{"Enter"===e.key&&this.handleLogin()}),i.addEventListener("keypress",e=>{"Enter"===e.key&&this.handleLogin()}),e.appendChild(t),e.appendChild(s),e.appendChild(n),e.appendChild(a),e.appendChild(i),e.appendChild(r),e.appendChild(d),e.appendChild(o),e.appendChild(l),this.element.appendChild(e);const h=document.createElement("div");h.className="auth-footer";const c=(new Date).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),u=(new Date).toLocaleDateString("ru-RU");return h.textContent=c+" "+u,this.element.appendChild(h),this.element}validateForm(){const e=document.getElementById("login-input"),t=document.getElementById("password-input"),s=document.querySelector(".auth-button");if(e&&t&&s){const n=e.value.trim(),i=t.value.trim(),r=a.validateLoginForm(n,i);s.disabled=!!r}}handleLogin(){const e=document.getElementById("login-input"),t=document.getElementById("password-input");if(e&&t){const s=e.value.trim(),n=t.value.trim(),i=a.validateLoginForm(s,n);if(i)return void this.showError(i);this.loginCallback(s,n)}}showError(e){const t=document.getElementById("auth-error");t&&(t.textContent=e,t.style.display="block")}clearError(){const e=document.getElementById("auth-error");e&&(e.textContent="",e.style.display="none")}}class r{constructor(e,t,s){this.userName=e,this.logoutCallback=t,this.showAboutCallback=s,this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className="header";const e=document.createElement("div");e.className="header-user-info",e.textContent=`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${this.userName}`;const t=document.createElement("div");t.className="header-app-name",t.textContent="–í–µ—Å–µ–ª—ã–π —á–∞—Ç–∏–∫";const s=document.createElement("div");s.className="header-buttons";const n=document.createElement("button");n.textContent="–ò–Ω—Ñ–æ",n.className="header-button",n.addEventListener("click",()=>this.showAboutCallback());const a=document.createElement("button");a.textContent="–í—ã—Ö–æ–¥",a.className="header-button",a.addEventListener("click",()=>this.logoutCallback());const i=document.createElement("button");return i.textContent="RU",i.className="header-language-button",s.appendChild(n),s.appendChild(a),s.appendChild(i),this.element.appendChild(e),this.element.appendChild(t),this.element.appendChild(s),this.element}updateUserName(e){this.userName=e;const t=this.element.querySelector(".header-user-info");t&&(t.textContent=`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${e}`)}}class d{constructor(){this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className="footer";const e=(new Date).getFullYear(),t=document.createElement("div");t.className="footer-content";const s=document.createElement("span");s.textContent="RSSchool";const n=document.createElement("a");n.href="https://github.com/afedziukovich",n.textContent="afedziukovich",n.target="_blank",n.rel="noopener noreferrer";const a=document.createElement("span");return a.textContent=e.toString(),t.appendChild(s),t.appendChild(n),t.appendChild(a),this.element.appendChild(t),this.element}}class o{constructor(){this.users=[],this.currentUser="",this.unreadCounts=new Map,this.userClickCallback=()=>{},this.element=document.createElement("div")}setUserClickCallback(e){this.userClickCallback=e}render(){this.element.innerHTML="",this.element.className="user-list";const e=document.createElement("div");e.className="user-search-container";const t=document.createElement("input");t.type="text",t.placeholder="–ü–æ–∏—Å–∫...",t.className="user-search-input",t.addEventListener("input",e=>{this.filterUsers(e.target.value)}),e.appendChild(t),this.element.appendChild(e);const s=document.createElement("div");return s.className="users-container",this.element.appendChild(s),this.renderUsers(),this.element}setCurrentUser(e){this.currentUser=e,this.renderUsers()}setUsers(e){this.users=e.filter(e=>e.login!==this.currentUser),this.renderUsers()}setUnreadCount(e,t){this.unreadCounts.set(e,t),this.updateUserItem(e)}filterUsers(e){const t=this.users.filter(t=>t.login.toLowerCase().includes(e.toLowerCase()));this.renderFilteredUsers(t)}renderUsers(){const e=this.users.filter(e=>e.login!==this.currentUser);this.renderFilteredUsers(e)}renderFilteredUsers(e){const t=this.element.querySelector(".users-container");if(t){if(t.innerHTML="",0===e.length){const e=document.createElement("div");return e.className="user-empty-message",e.textContent="–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",void t.appendChild(e)}e.forEach(e=>{const s=this.createUserElement(e);t.appendChild(s)})}}createUserElement(e){const t=document.createElement("div");t.className="user-item",t.dataset.login=e.login;const s=document.createElement("span");s.className="user-name",s.textContent=e.login;const n=document.createElement("span");n.className="user-status "+(e.isLogined?"online":"offline"),n.setAttribute("title",e.isLogined?"–í —Å–µ—Ç–∏":"–ù–µ –≤ —Å–µ—Ç–∏");const a=document.createElement("span");a.className="user-unread-badge";const i=this.unreadCounts.get(e.login)||0;return i>0?(a.textContent=i.toString(),a.style.display="inline-block"):a.style.display="none",t.appendChild(s),t.appendChild(n),t.appendChild(a),t.addEventListener("click",()=>{this.userClickCallback(e.login)}),t}updateUserItem(e){const t=this.element.querySelector(`.user-item[data-login="${e}"]`);if(!t)return;const s=t.querySelector(".user-unread-badge"),n=this.unreadCounts.get(e)||0;s&&(n>0?(s.textContent=n.toString(),s.style.display="inline-block"):s.style.display="none")}updateUserStatus(e,t){const s=this.users.find(t=>t.login===e);if(s){s.isLogined=t;const n=this.element.querySelector(`.user-item[data-login="${e}"]`);if(n){const e=n.querySelector(".user-status");e&&(e.className="user-status "+(t?"online":"offline"),e.setAttribute("title",t?"–í —Å–µ—Ç–∏":"–ù–µ –≤ —Å–µ—Ç–∏"))}}}}class l{constructor(e,t,s,n){this.message=e,this.isCurrentUser=t,this.onDelete=s,this.onEdit=n,this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className="message-item "+(this.isCurrentUser?"own":"other"),this.element.dataset.messageId=this.message.id;const e=document.createElement("div");e.className="message-header";const t=document.createElement("span");t.className="message-sender",t.textContent=this.isCurrentUser?"–í—ã":this.message.from;const s=document.createElement("span");s.className="message-time";const n=new Date(this.message.datetime);s.textContent=n.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),e.appendChild(t),e.appendChild(s);const a=document.createElement("div");if(a.className="message-content",this.message.status.isDeleted){const e=document.createElement("div");e.className="message-text deleted",e.textContent="–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ",a.appendChild(e)}else{const e=document.createElement("div");if(e.className="message-text",e.textContent=this.message.text,this.message.status.isEdited){const t=document.createElement("span");t.className="message-edited",t.textContent=" (–∏–∑–º–µ–Ω–µ–Ω–æ)",e.appendChild(t)}a.appendChild(e)}const i=document.createElement("div");if(i.className="message-footer",this.isCurrentUser){const e=document.createElement("div");e.className="message-status-container";const t=document.createElement("span");if(t.className="message-status-icon",this.message.status.isReaded?(t.textContent="‚úì‚úì",t.title="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"):this.message.status.isDelivered?(t.textContent="‚úì",t.title="–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ"):(t.textContent="‚è≥",t.title="–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è"),e.appendChild(t),i.appendChild(e),!this.message.status.isDeleted){const e=document.createElement("div");e.className="message-actions";const t=document.createElement("button");t.textContent="‚úé",t.className="message-action-button",t.title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å",t.addEventListener("click",()=>this.handleEdit());const s=document.createElement("button");s.textContent="üóë",s.className="message-action-button",s.title="–£–¥–∞–ª–∏—Ç—å",s.addEventListener("click",()=>{this.onDelete&&this.onDelete(this.message.id)}),e.appendChild(t),e.appendChild(s),i.appendChild(e)}}return this.element.appendChild(e),this.element.appendChild(a),this.element.appendChild(i),this.element}handleEdit(){const e=prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:",this.message.text);null!==e&&""!==e.trim()&&this.onEdit&&this.onEdit(this.message.id,e.trim())}updateStatus(e,t){this.message.status.isDelivered=e,this.message.status.isReaded=t;const s=this.element.querySelector(".message-status-icon");s&&(t?(s.textContent="‚úì‚úì",s.title="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"):e&&(s.textContent="‚úì",s.title="–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ"))}updateText(e,t){this.message.text=e,this.message.status.isEdited=t;const s=this.element.querySelector(".message-text");if(s&&(s.textContent=e,t)){const e=document.createElement("span");e.className="message-edited",e.textContent=" (–∏–∑–º–µ–Ω–µ–Ω–æ)",s.appendChild(e)}}markAsDeleted(){this.message.status.isDeleted=!0,this.render()}}class h{constructor(e,t,s,n){this.onSendMessage=e,this.onDeleteMessage=t,this.onEditMessage=s,this.onMarkAsRead=n,this.messages=[],this.currentUser="",this.selectedUser="",this.messageItems=new Map,this.hasUnreadDivider=!1,this.unreadDividerElement=null,this.lastReadIndex=-1,this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className=h.CLASS_NAMES.CHAT_DIALOG;const e=document.createElement("div");e.className=h.CLASS_NAMES.DIALOG_HEADER;const t=document.createElement("div");t.className=h.CLASS_NAMES.DIALOG_USER_INFO,t.id=h.CLASS_NAMES.DIALOG_USER_INFO;const s=document.createElement("span");s.className=h.CLASS_NAMES.DIALOG_USER_STATUS,s.id=h.CLASS_NAMES.DIALOG_USER_STATUS,t.appendChild(s),e.appendChild(t),this.element.appendChild(e);const n=document.createElement("div");n.className=h.CLASS_NAMES.MESSAGES_CONTAINER,n.id=h.CLASS_NAMES.MESSAGES_CONTAINER,n.addEventListener("scroll",()=>this.handleScroll()),n.addEventListener("click",()=>this.handleClick()),this.element.appendChild(n);const a=document.createElement("div");a.className=h.CLASS_NAMES.MESSAGE_INPUT_CONTAINER;const i=document.createElement("input");i.type="text",i.placeholder=h.TEXT.YOUR_MESSAGE,i.className=h.CLASS_NAMES.MESSAGE_INPUT,i.id=h.CLASS_NAMES.MESSAGE_INPUT,i.disabled=!this.selectedUser;const r=document.createElement("button");return r.textContent=h.TEXT.SEND,r.className=h.CLASS_NAMES.SEND_BUTTON,r.id=h.CLASS_NAMES.SEND_BUTTON,r.disabled=!this.selectedUser,i.addEventListener("keypress",e=>{"Enter"!==e.key||r.disabled||this.sendMessage()}),r.addEventListener("click",()=>{this.sendMessage()}),a.appendChild(i),a.appendChild(r),this.element.appendChild(a),this.updateDialogInfo(),this.renderMessages(),this.element}setCurrentUser(e){this.currentUser=e}setSelectedUser(e,t){this.selectedUser=e,this.messages=[],this.messageItems.clear(),this.hasUnreadDivider=!1,this.lastReadIndex=-1;const s=document.getElementById(h.CLASS_NAMES.MESSAGE_INPUT),n=document.getElementById(h.CLASS_NAMES.SEND_BUTTON);s&&n&&(s.disabled=!e,n.disabled=!e,s.value=""),this.updateDialogInfo(e,t),this.renderMessages()}setMessages(e){this.messages=e.sort((e,t)=>e.datetime-t.datetime),this.messageItems.clear();const t=this.findLastReadIndex();-1!==t&&t<this.messages.length-1?(this.hasUnreadDivider=!0,this.lastReadIndex=t):(this.hasUnreadDivider=!1,this.lastReadIndex=-1),this.renderMessages()}addMessage(e){this.messages.push(e),this.messageItems.delete(e.id),e.to!==this.currentUser||e.status.isReaded||(this.hasUnreadDivider=!0),this.renderMessages(),this.scrollToBottom()}updateMessageStatus(e,t,s){const n=this.messageItems.get(e);if(n&&n.updateStatus(t,s),s&&this.hasUnreadDivider){const t=this.messages.findIndex(t=>t.id===e);t>this.lastReadIndex&&(this.lastReadIndex=t,this.checkUnreadDivider())}}updateMessageText(e,t,s){const n=this.messageItems.get(e);n&&n.updateText(t,s)}deleteMessage(e){const t=this.messageItems.get(e);t&&t.markAsDeleted()}updateUserStatus(e){this.updateDialogInfo(this.selectedUser,e)}updateDialogInfo(e,t){const s=document.getElementById(h.CLASS_NAMES.DIALOG_USER_INFO),n=document.getElementById(h.CLASS_NAMES.DIALOG_USER_STATUS);s&&n&&(e?(n.textContent=e,n.className=`${h.CLASS_NAMES.DIALOG_USER_STATUS} ${t?h.CLASS_NAMES.ONLINE:h.CLASS_NAMES.OFFLINE}`,n.title=t?h.TEXT.ONLINE:h.TEXT.OFFLINE):(n.textContent=h.TEXT.SELECT_USER,n.className=h.CLASS_NAMES.DIALOG_USER_STATUS))}renderMessages(){const e=document.getElementById(h.CLASS_NAMES.MESSAGES_CONTAINER);if(e){if(e.innerHTML="",0===this.messages.length){const t=document.createElement("div");return t.className=h.CLASS_NAMES.EMPTY_DIALOG_MESSAGE,this.selectedUser?t.textContent=h.TEXT.START_OF_DIALOG:t.textContent=h.TEXT.SELECT_USER,void e.appendChild(t)}this.messages.forEach((t,s)=>{const n=t.from===this.currentUser;this.hasUnreadDivider&&s===this.lastReadIndex+1&&(this.unreadDividerElement=document.createElement("div"),this.unreadDividerElement.className=h.CLASS_NAMES.UNREAD_DIVIDER,this.unreadDividerElement.textContent=h.TEXT.NEW_MESSAGES,e.appendChild(this.unreadDividerElement));const a=new l(t,n,n?this.onDeleteMessage:void 0,n?this.onEditMessage:void 0),i=a.render();this.messageItems.set(t.id,a),t.to!==this.currentUser||t.status.isReaded||this.onMarkAsRead(t.id),e.appendChild(i)}),this.scrollToBottom()}}sendMessage(){const e=document.getElementById(h.CLASS_NAMES.MESSAGE_INPUT);if(!e)return;const t=e.value.trim();t?(this.onSendMessage(t),e.value=""):console.warn("–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")}scrollToBottom(){const e=document.getElementById(h.CLASS_NAMES.MESSAGES_CONTAINER);e&&(e.scrollTop=e.scrollHeight)}handleScroll(){if(this.hasUnreadDivider&&this.unreadDividerElement){const e=document.getElementById(h.CLASS_NAMES.MESSAGES_CONTAINER);if(e){const t=this.unreadDividerElement.getBoundingClientRect(),s=e.getBoundingClientRect();t.top>s.top&&this.removeUnreadDivider()}}}handleClick(){this.hasUnreadDivider&&this.removeUnreadDivider()}removeUnreadDivider(){this.hasUnreadDivider=!1,this.unreadDividerElement&&(this.unreadDividerElement.remove(),this.unreadDividerElement=null)}findLastReadIndex(){for(let e=this.messages.length-1;e>=0;e--)if(this.messages[e].status.isReaded)return e;return-1}checkUnreadDivider(){!this.messages.some((e,t)=>t>this.lastReadIndex&&!e.status.isReaded)&&this.hasUnreadDivider&&this.removeUnreadDivider()}}h.CLASS_NAMES={CHAT_DIALOG:"chat-dialog",DIALOG_HEADER:"dialog-header",DIALOG_USER_INFO:"dialog-user-info",DIALOG_USER_STATUS:"dialog-user-status",ONLINE:"online",OFFLINE:"offline",MESSAGES_CONTAINER:"messages-container",EMPTY_DIALOG_MESSAGE:"empty-dialog-message",MESSAGE_INPUT_CONTAINER:"message-input-container",MESSAGE_INPUT:"message-input",SEND_BUTTON:"send-button",UNREAD_DIVIDER:"unread-divider"},h.TEXT={SELECT_USER:"–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è...",START_OF_DIALOG:"–≠—Ç–æ –Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞",YOUR_MESSAGE:"–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",SEND:"–û—Ç–ø—Ä–∞–≤–∏—Ç—å",NEW_MESSAGES:"–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è",ONLINE:"–í —Å–µ—Ç–∏",OFFLINE:"–ù–µ –≤ —Å–µ—Ç–∏"};class c{constructor(e,t,s,n,a,i,l,c,u){this.selectedUser="",this.unsubscribe=null,this.element=document.createElement("div"),this.element.className="main-page",this.stateManager=u,this.header=new r(e,t,s),this.footer=new d,this.userList=new o,this.chatDialog=new h(e=>{this.selectedUser&&n(this.selectedUser,e)},a,i,l),this.chatDialog.setCurrentUser(e),this.userList.setUserClickCallback(e=>{this.selectedUser=e,this.chatDialog.setSelectedUser(e,!0),c(e)}),this.subscribeToState()}subscribeToState(){this.unsubscribe&&this.unsubscribe(),this.unsubscribe=this.stateManager.subscribe(e=>{e.users&&this.setUsers(e.users),e.userStatuses&&Object.entries(e.userStatuses).forEach(([e,t])=>{this.updateUserStatus(e,t.isOnline)}),this.selectedUser&&e.messages&&e.messages[this.selectedUser]&&this.setMessages(e.messages[this.selectedUser]),e.unreadCounts&&Object.entries(e.unreadCounts).forEach(([e,t])=>{this.setUnreadCount(e,t)})})}render(){this.element.innerHTML="";const e=this.header.render();this.element.appendChild(e);const t=document.createElement("div");t.className="main-content";const s=document.createElement("div");s.className="sidebar";const n=this.userList.render();s.appendChild(n);const a=this.chatDialog.render();t.appendChild(s),t.appendChild(a),this.element.appendChild(t);const i=this.footer.render();return this.element.appendChild(i),this.element}destroy(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}updateUserName(e){this.header.updateUserName(e),this.chatDialog.setCurrentUser(e)}setUsers(e){this.userList.setUsers(e)}setUnreadCount(e,t){this.userList.setUnreadCount(e,t)}setMessages(e){this.chatDialog.setMessages(e)}addMessage(e){this.chatDialog.addMessage(e)}updateMessageStatus(e,t,s){this.chatDialog.updateMessageStatus(e,t,s)}updateMessageText(e,t,s){this.chatDialog.updateMessageText(e,t,s)}deleteMessage(e){this.chatDialog.deleteMessage(e)}updateUserStatus(e,t){this.userList.updateUserStatus(e,t),e===this.selectedUser&&this.chatDialog.updateUserStatus(t)}}class u{constructor(e){this.backCallback=e,this.element=document.createElement("div")}render(){this.element.innerHTML="",this.element.className="about-page";const e=document.createElement("div");e.className="about-container";const t=document.createElement("h1");t.textContent="–í–µ—Å–µ–ª—ã–π —á–∞—Ç",t.className="about-title";const s=document.createElement("div");s.className="about-description",s.innerHTML="\n      –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–Ω–∏—è Fun Chat –≤ —Ä–∞–º–∫–∞—Ö –∫—É—Ä—Å–∞ RSSchool JS/FE 2025Q3<br>\n      –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–¥–∏–Ω —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏\n    ";const n=document.createElement("div");n.className="about-author",n.textContent="–ê–≤—Ç–æ—Ä MikAleinik, Afedziukovich";const a=document.createElement("button");return a.textContent="–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥",a.className="about-back-button",a.addEventListener("click",()=>this.backCallback()),e.appendChild(t),e.appendChild(s),e.appendChild(n),e.appendChild(a),this.element.appendChild(e),this.element}}class m{constructor(){this.currentPage=null,this.mainPage=null,this.messageCounter=0,this.appContainer=document.getElementById("app"),this.router=new e,this.stateManager=new t,this.wsClient=new n,this.authPage=new i((e,t)=>this.handleLogin(e,t),()=>this.router.navigate("/about")),this.aboutPage=new u(()=>{this.stateManager.getState().isAuthenticated?this.router.navigate("/"):this.router.navigate("/login")}),this.setupRouter(),this.setupWebSocket()}init(){this.router.start()}setupRouter(){this.router.addRoute("/login",()=>{this.stateManager.getState().isAuthenticated?this.router.navigate("/"):this.showAuthPage()}),this.router.addRoute("/",()=>{this.stateManager.getState().isAuthenticated?this.showMainPage():this.router.navigate("/login")}),this.router.addRoute("/about",()=>{this.showAboutPage()}),this.router.addRoute("",()=>{this.router.navigate("/login")})}setupWebSocket(){this.wsClient.connect("wss://fun-chat-server.onrender.com"),this.wsClient.onEvent(s.CONNECTED,()=>{console.log("WebSocket connected")}),this.wsClient.onEvent(s.DISCONNECTED,()=>{console.log("WebSocket disconnected")}),this.wsClient.onEvent(s.ERROR,e=>{console.error("WebSocket error:",e)}),this.wsClient.onEvent(s.USER_LOGIN,e=>{e?.user?.isLogined&&(this.stateManager.setCurrentUser(e.user.login),this.stateManager.setAuthenticated(!0),this.requestActiveUsers(),this.router.navigate("/"))}),this.wsClient.onEvent(s.ERROR_RESPONSE,e=>{this.currentPage===this.authPage.render()&&this.authPage.showError(e?.error||"Unknown error")}),this.wsClient.onEvent(s.USER_EXTERNAL_LOGIN,e=>{e?.user?.login&&this.updateUserStatus(e.user.login,!0)}),this.wsClient.onEvent(s.USER_EXTERNAL_LOGOUT,e=>{e?.user?.login&&this.updateUserStatus(e.user.login,!1)}),this.wsClient.onEvent(s.USER_ACTIVE,e=>{e?.users&&this.stateManager.setUsers(e.users)}),this.wsClient.onEvent(s.MSG_SEND,e=>{e?.message&&this.handleIncomingMessage(e.message)}),this.wsClient.onEvent(s.MSG_DELIVER,e=>{e?.message?.id&&this.stateManager.updateMessageStatus(e.message.id,!0,!1)}),this.wsClient.onEvent(s.MSG_READ,e=>{e?.message?.id&&this.stateManager.updateMessageStatus(e.message.id,!0,!0)}),this.wsClient.onEvent(s.MSG_EDIT,e=>{e?.message?.id&&e?.message?.text&&this.stateManager.updateMessageText(e.message.id,e.message.text)}),this.wsClient.onEvent(s.MSG_DELETE,e=>{e?.message?.id&&this.stateManager.deleteMessage(e.message.id)})}showAuthPage(){this.currentPage=this.authPage.render(),this.appContainer.innerHTML="",this.appContainer.appendChild(this.currentPage)}showMainPage(){const e=this.stateManager.getState();this.mainPage?this.mainPage.updateUserName(e.currentUser):this.mainPage=new c(e.currentUser,()=>this.handleLogout(),()=>this.router.navigate("/about"),(e,t)=>this.sendMessage(e,t),e=>this.deleteMessage(e),(e,t)=>this.editMessage(e,t),e=>this.markAsRead(e),e=>this.requestMessages(e),this.stateManager),this.currentPage=this.mainPage.render(),this.appContainer.innerHTML="",this.appContainer.appendChild(this.currentPage)}showAboutPage(){this.currentPage=this.aboutPage.render(),this.appContainer.innerHTML="",this.appContainer.appendChild(this.currentPage)}handleLogin(e,t){setTimeout(()=>{const n=this.generateRequestId();this.wsClient.sendRequest({id:n,type:s.USER_LOGIN,payload:{user:{login:e,password:t}}})},1500)}handleLogout(){const e=this.stateManager.getState(),t=this.generateRequestId();this.wsClient.sendRequest({id:t,type:s.USER_LOGOUT,payload:{user:{login:e.currentUser}}}),this.stateManager.setAuthenticated(!1),this.stateManager.setCurrentUser(null),this.mainPage=null,this.router.navigate("/login")}requestActiveUsers(){const e=this.generateRequestId();this.wsClient.sendRequest({id:e,type:s.USER_ACTIVE,payload:null})}sendMessage(e,t){if(!t.trim())return;const n=this.generateRequestId();this.wsClient.sendRequest({id:n,type:s.MSG_SEND,payload:{message:{to:e,text:t}}})}deleteMessage(e){const t=this.generateRequestId();this.wsClient.sendRequest({id:t,type:s.MSG_DELETE,payload:{message:{id:e}}})}editMessage(e,t){if(!t.trim())return;const n=this.generateRequestId();this.wsClient.sendRequest({id:n,type:s.MSG_EDIT,payload:{message:{id:e,text:t}}})}markAsRead(e){const t=this.generateRequestId();this.wsClient.sendRequest({id:t,type:s.MSG_READ,payload:{message:{id:e}}})}requestMessages(e){const t=this.generateRequestId();this.wsClient.onMessage(t,e=>{e.type===s.MSG_FROM_USER&&e.payload?.messages&&this.stateManager.setMessages(e.payload.messages)}),this.wsClient.sendRequest({id:t,type:s.MSG_FROM_USER,payload:{user:{login:e}}});const n=this.generateRequestId();this.wsClient.onMessage(n,t=>{t.type===s.MSG_COUNT_NOT_READED_FROM_USER&&void 0!==t.payload?.count&&this.stateManager.setUnreadCount(e,t.payload.count)}),this.wsClient.sendRequest({id:n,type:s.MSG_COUNT_NOT_READED_FROM_USER,payload:{user:{login:e}}})}handleIncomingMessage(e){this.stateManager.addMessage(e)}updateUserStatus(e,t){const s=this.stateManager.getState().users.map(s=>s.login===e?{...s,isLogined:t}:s);this.stateManager.setUsers(s)}generateRequestId(){return this.messageCounter++,`req_${Date.now()}_${this.messageCounter}`}}function E(){try{(new m).init()}catch(e){console.error("Failed to initialize application:",e),function(e){const t=document.getElementById("app");t&&(t.innerHTML=`\n      <div class="error-container">\n        <h2>Application Error</h2>\n        <p>${e}</p>\n        <p>Please reload the page</p>\n        <button onclick="window.location.reload()">Reload</button>\n      </div>\n    `)}(e instanceof Error?e.message:"Unknown error")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",E):E()})();